<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Teste de Prosperidade</title>
    <script src="https://www.mercadopago.com/v2/security.js" view="checkout"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; padding: 20px; display: flex; align-items: center; justify-content: center; }
        .checkout-container { max-width: 500px; width: 100%; background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); overflow: hidden; }
        .checkout-header { padding: 24px 32px 20px; background: white; border-bottom: 1px solid #f0f0f0; }
        .checkout-header h2 { font-size: 20px; font-weight: 500; color: #333; margin-bottom: 8px; }
        .amount-display { font-size: 24px; font-weight: 600; color: #00a650; margin-bottom: 12px; }
        .completion-message { font-size: 14px; color: #666; background: #f8f9fa; padding: 12px 16px; border-radius: 6px; border: 1px solid #e9ecef; text-align: center; margin-top: 8px; }
        .user-info { font-size: 12px; color: #666; background: #e6f7ff; padding: 8px 16px; border-radius: 4px; margin-top: 8px; border: 1px solid #91d5ff; }
        .user-info .uid { font-weight: 500; color: #1890ff; }
        .user-info .email { color: #52c41a; }
        .payment-container { padding: 20px; background: white; }
        #paymentBrick_container { min-height: 400px; width: 100%; }
        .loading-state { padding: 60px 32px; text-align: center; color: #666; }
        .spinner { width: 32px; height: 32px; border: 3px solid #f3f3f3; border-top: 3px solid #009ee3; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .mp-logo-footer { padding: 12px 32px 8px; text-align: center; background: white; border-top: 1px solid #f0f0f0; }
        .mp-logo-img { height: 64px; margin-bottom: 8px; opacity: 0.9; }
        .mp-security-text { font-size: 12px; color: #666; font-weight: 500; }
        .status-screen { display: none; background: #f5f5f5; min-height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 1000; padding: 20px; }
        .status-container { max-width: 600px; margin: 0 auto; padding-top: 40px; }
        .status-header { border-radius: 20px 20px 0 0; padding: 60px 0 20px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .status-header.success { background: linear-gradient(135deg, #52c41a, #389e0d); }
        .status-header.processing { background: linear-gradient(135deg, #fa8c16, #d46b08); }
        .status-header.error { background: linear-gradient(135deg, #ff4d4f, #cf1322); }
        .status-icon { width: 80px; height: 80px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold; }
        .status-content { background: white; border-radius: 0 0 20px 20px; padding: 60px 40px 120px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .status-title { font-size: 28px; font-weight: 600; color: #333; text-align: center; margin-bottom: 20px; }
        .status-subtitle { font-size: 16px; color: #666; text-align: center; margin-bottom: 30px; line-height: 1.5; }
        .payment-details { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #e9ecef; }
        .detail-row { display: flex; align-items: center; margin-bottom: 16px; }
        .detail-row:last-child { margin-bottom: 0; }
        .detail-icon { width: 40px; height: 40px; border-radius: 50%; background: #fff3cd; display: flex; align-items: center; justify-content: center; margin-right: 16px; }
        .detail-content { flex: 1; }
        .detail-title { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 4px; }
        .detail-subtitle { font-size: 14px; color: #666; }
        .countdown-section { text-align: center; margin: 30px 0; padding: 20px; background: #e6f7ff; border-radius: 8px; border: 1px solid #91d5ff; }
        .countdown-text { font-size: 16px; color: #1890ff; margin-bottom: 8px; }
        .countdown-timer { font-size: 24px; font-weight: 600; color: #1890ff; }
        .action-button { width: 100%; max-width: 300px; padding: 16px; background: #1890ff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; margin: 16px auto; display: block; }
        .action-button:hover { background: #40a9ff; }
        .action-button:disabled { background: #d9d9d9; cursor: not-allowed; }
        .back-link { display: block; text-align: center; color: #1890ff; text-decoration: none; font-size: 16px; padding: 12px; }
        .pix-info { background: #f0f9ff; border: 1px solid #b3d4fc; border-radius: 8px; padding: 32px; margin-top: 20px; }
        .pix-qr { text-align: center; margin: 20px 0; }
        .pix-qr img { max-width: 200px; border: 1px solid #ddd; border-radius: 8px; }
        .pix-code { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; word-break: break-all; margin: 10px 0; }
        .copy-button { background: #52c41a; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .copy-button:hover { background: #389e0d; }
    </style>
</head>
<body>
    <div id="checkoutSection" class="checkout-container">
        <div class="checkout-header">
            <h2>Teste de Prosperidade</h2>
            <div class="amount-display">R$ 19,00</div>
            <div class="completion-message">
                💡 Complete o pagamento para acessar seu resultado personalizado
            </div>
            <div id="userInfo" class="user-info" style="display: none;">
                <span class="uid">UID: <span id="displayUID"></span></span> | 
                <span class="email">Email: <span id="displayEmail"></span></span>
            </div>
        </div>

        <div class="payment-container">
            <div id="paymentBrick_container">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Carregando formas de pagamento...</p>
                </div>
            </div>
        </div>

        <div class="mp-logo-footer">
            <img src="https://raw.githubusercontent.com/renatoambrosi/mpfullbackfront/main/EXEMPLOS/quizfront-main/mercado_pago-logo.png" 
                 alt="Mercado Pago" class="mp-logo-img">
            <div class="mp-security-text">Pagamento 100% seguro</div>
        </div>
    </div>

    <div id="statusScreen" class="status-screen">
        <div class="status-container">
            <div id="statusHeader" class="status-header success">
                <div id="statusIcon" class="status-icon">✓</div>
            </div>
            <div class="status-content">
                <h1 id="statusTitle" class="status-title">Seu pagamento foi aprovado</h1>
                <p id="statusSubtitle" class="status-subtitle"></p>
                
                <div class="payment-details">
                    <div class="detail-row">
                        <div class="detail-icon">💰</div>
                        <div class="detail-content">
                            <div class="detail-title">R$ 19,00</div>
                            <div class="detail-subtitle">Teste de Prosperidade</div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-icon">📋</div>
                        <div class="detail-content">
                            <div class="detail-title">Operação #<span id="paymentId"></span></div>
                            <div class="detail-subtitle" id="operationDate"></div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-icon">📧</div>
                        <div class="detail-content">
                            <div class="detail-title">Email: <span id="statusEmail"></span></div>
                            <div class="detail-subtitle">Confirmação enviada</div>
                        </div>
                    </div>
                </div>

                <div id="pixSection" class="pix-info" style="display: none;">
                    <h3>Pagamento PIX</h3>
                    <div class="pix-qr">
                        <img id="pixQRCode" src="" alt="QR Code PIX" style="display: none;">
                    </div>
                    <div>
                        <strong>Código PIX para copiar:</strong>
                        <div id="pixCode" class="pix-code"></div>
                        <button class="copy-button" onclick="copyPixCode()">Copiar código</button>
                    </div>
                </div>

                <div id="countdownSection" class="countdown-section">
                    <div class="countdown-text">Redirecionando para seu resultado em:</div>
                    <div id="countdownTimer" class="countdown-timer">10</div>
                </div>

                <button id="resultButton" class="action-button">Ver Resultado do Teste Agora</button>
                <a href="https://mpfullfront.vercel.app" class="back-link">Voltar à página inicial</a>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://mpfullbackfront-production.up.railway.app';
        const PUBLIC_KEY = 'APP_USR-d46b1349-ce1d-4bea-b49d-8c5e5d7f82b6';
        
        const urlParams = new URLSearchParams(window.location.search);
        const tallyUID = urlParams.get('uid');
        const userEmail = urlParams.get('email');
        const userUID = tallyUID || 'checkout-' + Date.now();
        
        function isValidEmail(email) {
            if (!email) return false;
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        const finalEmail = isValidEmail(userEmail) ? userEmail : 'cliente@testeprospero.com.br';
        
        function displayUserData() {
            if (tallyUID || userEmail) {
                document.getElementById('displayUID').textContent = tallyUID || 'N/A';
                document.getElementById('displayEmail').textContent = userEmail || 'N/A';
                document.getElementById('userInfo').style.display = 'block';
            }
        }
        
        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt' });
        const bricksBuilder = mp.bricks();
        
        function waitForDeviceFingerprint() {
            return new Promise((resolve) => {
                let attempts = 0;
                const check = () => {
                    if (window.MP_DEVICE_SESSION_ID || attempts++ > 50) {
                        resolve(window.MP_DEVICE_SESSION_ID || null);
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        let pollingInterval = null;

        function startPolling(paymentId) {
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/payment/${paymentId}`);
                    const data = await response.json();
                    if (data.status === 'approved') {
                        clearInterval(pollingInterval);
                        showStatusScreen('success', data);
                    }
                } catch (e) {}
            }, 3000);
        }

        function showStatusScreen(type, paymentData = {}) {
            document.getElementById('checkoutSection').style.display = 'none';
            
            const statusScreen = document.getElementById('statusScreen');
            const statusHeader = document.getElementById('statusHeader');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusSubtitle = document.getElementById('statusSubtitle');
            const paymentId = document.getElementById('paymentId');
            const statusEmail = document.getElementById('statusEmail');
            const pixSection = document.getElementById('pixSection');
            const countdownSection = document.getElementById('countdownSection');
            const resultButton = document.getElementById('resultButton');

            statusEmail.textContent = finalEmail;
            if (paymentData.id) paymentId.textContent = paymentData.id;

            if (type === 'success') {
                statusHeader.className = 'status-header success';
                statusIcon.textContent = '✓';
                statusTitle.textContent = 'Seu pagamento foi aprovado';
                statusSubtitle.textContent = 'Parabéns! Agora você pode acessar seu resultado personalizado.';
                countdownSection.style.display = 'block';
                pixSection.style.display = 'none';
                resultButton.onclick = () => redirectToResult();
                startCountdown();
            } else if (type === 'pix') {
                statusHeader.className = 'status-header processing';
                statusIcon.textContent = '⏳';
                statusTitle.textContent = 'Pague com PIX';
                statusSubtitle.textContent = 'Escaneie o QR Code ou copie o código PIX.';
                countdownSection.style.display = 'none';
                
                if (paymentData.qr_code_base64) {
                    document.getElementById('pixQRCode').src = `data:image/png;base64,${paymentData.qr_code_base64}`;
                    document.getElementById('pixQRCode').style.display = 'block';
                }
                if (paymentData.qr_code) {
                    document.getElementById('pixCode').textContent = paymentData.qr_code;
                    window.pixCodeToCopy = paymentData.qr_code;
                }
                
                pixSection.style.display = 'block';
                resultButton.textContent = 'Já paguei - Ver resultado';
                resultButton.onclick = () => redirectToResult();
                
                if (paymentData.id) startPolling(paymentData.id);
            }

            statusScreen.style.display = 'block';
        }

        function startCountdown() {
            let seconds = 10;
            const timer = document.getElementById('countdownTimer');
            const interval = setInterval(() => {
                timer.textContent = --seconds;
                if (seconds <= 0) {
                    clearInterval(interval);
                    redirectToResult();
                }
            }, 1000);
        }

        function redirectToResult() {
            const finalUID = tallyUID || userUID;
            window.location.href = `https://suellenseragi.com.br/resultado1?uid=${finalUID}`;
        }

        function copyPixCode() {
            if (window.pixCodeToCopy) {
                navigator.clipboard.writeText(window.pixCodeToCopy);
                const button = document.querySelector('.copy-button');
                button.textContent = 'Copiado!';
                setTimeout(() => button.textContent = 'Copiar código', 2000);
            }
        }

        async function renderPaymentBrick() {
            try {
                const deviceId = await waitForDeviceFingerprint();
                
                await bricksBuilder.create("payment", "paymentBrick_container", {
                    initialization: {
                        amount: 19,
                        payer: { email: finalEmail }
                    },
                    customization: {
                        paymentMethods: {
                            creditCard: "all",
                            ticket: false,
                            debitCard: false,
                            bankTransfer: "all",
                            mercadoPago: false,
                            atm: false
                        }
                    },
                    callbacks: {
                        onReady: () => {
                            console.log('Payment Brick carregado');
                            document.querySelector('.loading-state').style.display = 'none';
                        },
                        onError: (error) => {
                            console.error('Erro Payment Brick:', error);
                            alert('Erro ao carregar Payment Brick');
                        },
                        onSubmit: ({ selectedPaymentMethod, formData }) => {
                            console.log('💳 Dados originais do Brick:', formData);
                            
                            return new Promise((resolve, reject) => {
                                // MAPEAR DADOS CORRETAMENTE PARA O BACKEND
                                const payload = {
                                    payment_method_id: formData.payment_method_id,
                                    transaction_amount: 19,
                                    description: 'Teste de Prosperidade - Resultado Personalizado',
                                    payer: {
                                        email: finalEmail
                                    },
                                    uid: userUID
                                };

                                // Adicionar campos condicionais para cartão
                                if (formData.token) payload.token = formData.token;
                                if (formData.installments) payload.installments = formData.installments;
                                if (formData.issuer_id) payload.issuer_id = formData.issuer_id;
                                if (formData.payer?.identification) {
                                    payload.payer.identification = formData.payer.identification;
                                }

                                console.log('📤 Payload corrigido para backend:', payload);

                                fetch(`${BACKEND_URL}/api/process_payment`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        return response.json().then(err => Promise.reject(err));
                                    }
                                    return response.json();
                                })
                                .then(result => {
                                    console.log('✅ Resultado:', result);
                                    
                                    if (result.status === 'approved') {
                                        showStatusScreen('success', result);
                                    } else if (result.status === 'pending' && result.payment_method_id === 'pix') {
                                        showStatusScreen('pix', result);
                                    } else {
                                        alert('Status inesperado: ' + result.status);
                                    }
                                    resolve();
                                })
                                .catch(error => {
                                    console.error('❌ Erro no pagamento:', error);
                                    alert('Erro no pagamento: ' + (error.message || error.error || 'Tente novamente'));
                                    reject(error);
                                });
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao criar Payment Brick:', error);
                document.getElementById('paymentBrick_container').innerHTML = 
                    '<div class="loading-state"><p style="color: red;">Erro ao carregar pagamentos</p><button onclick="location.reload()">Recarregar</button></div>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            displayUserData();
            renderPaymentBrick();
        });
    </script>
</body>
</html>
